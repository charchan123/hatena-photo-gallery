name: Build & Deploy Photo Gallery

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # é•·æ™‚é–“ã§ã‚‚å®‰å…¨
    strategy:
      fail-fast: false

    env:
      HATENA_USER: ${{ secrets.HATENA_USER }}
      HATENA_BLOG_ID: ${{ secrets.HATENA_BLOG_ID }}
      HATENA_API_KEY: ${{ secrets.HATENA_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªå–å¾—
        uses: actions/checkout@v4

      - name: ğŸ Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ====== ENV CHECK ======
      - name: ğŸ”‘ ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
        run: |
          echo "=== ENV CHECK ==="
          if [ -z "$HATENA_USER" ]; then echo "âŒ HATENA_USER missing"; exit 1; fi
          if [ -z "$HATENA_BLOG_ID" ]; then echo "âŒ HATENA_BLOG_ID missing"; exit 1; fi
          if [ -z "$HATENA_API_KEY" ]; then echo "âŒ HATENA_API_KEY missing"; exit 1; fi
          if [ -z "$OPENAI_API_KEY" ]; then echo "âŒ OPENAI_API_KEY missing"; exit 1; fi
          echo "âœ… All required env vars are present"

      # ====== MAIN PYTHON TASK ======
      - name: ğŸ§ª Python main.py å®Ÿè¡Œï¼ˆè¨˜äº‹å–å¾—â†’EXIFâ†’AIèª¬æ˜æ–‡â†’HTMLç”Ÿæˆï¼‰
        run: |
          echo "ğŸš€ Running main.py"
          python main.py

      # ====== ç”Ÿæˆç‰©ç¢ºèª ======
      - name: ğŸ“‚ å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ç¢ºèª
        run: |
          echo "=== OUTPUT DIR CONTENTS ==="
          ls -R output || echo "âš ï¸ output ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"

      # ====== Netlify / GitHub Pages é…ç½®å‘ã‘ ======
      - name: ğŸ“¤ GitHub Pages ç”¨ artifact ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: gallery-output
          path: output

  # ================================
  #  GitHub Pages ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆä»»æ„ï¼‰
  # ================================
  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ artifact ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: gallery-output
          path: output

      - name: ğŸŒ GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: output
