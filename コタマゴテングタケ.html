<div class='gallery'><a class="gallery-item" href="https://cdn-ak.f.st-hatena.com/images/fotolife/e/exsudoporus_ruber/20251103/20251103232359.jpg" data-exthumbimage="https://cdn-ak.f.st-hatena.com/images/fotolife/e/exsudoporus_ruber/20251103/20251103232359.jpg?width=300" data-sub-html="
    &lt;div style=&#x27;text-align:center;&#x27;&gt;
        &lt;div style=&#x27;font-weight:bold; font-size:1.2em; margin-bottom:6px;&#x27;&gt;„Ç≥„Çø„Éû„Ç¥„ÉÜ„É≥„Ç∞„Çø„Ç±&lt;/div&gt;
        &lt;div style=&#x27;font-size:0.9em; line-height:1.4;&#x27;&gt;„Ç´„É°„É©ÔºöDC-G9M2 | „É¨„É≥„Ç∫ÔºöOLYMPUS M.12-40mm F2.8 | ISOÔºö100 | Áµû„ÇäÔºöf/9.0 | „Ç∑„É£„ÉÉ„Çø„ÉºÈÄüÂ∫¶Ôºö1/1 | ÁÑ¶ÁÇπË∑ùÈõ¢Ôºö35mm | ÊíÆÂΩ±Êó•Ôºö2025/11/01&lt;/div&gt;
    &lt;/div&gt;
    "><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/e/exsudoporus_ruber/20251103/20251103232359.jpg" alt="„Ç≥„Çø„Éû„Ç¥„ÉÜ„É≥„Ç∞„Çø„Ç±" loading="lazy"></a></div>
        <div style='margin-top:40px; text-align:center;'>
            <a href='javascript:history.back()' style='text-decoration:none;color:#007acc;'>‚Üê Êàª„Çã</a>
        </div>
        <style>
html, body {
  margin: 0;
  padding: 0;
  overflow-y: hidden;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background:#fafafa;
  color:#333;
  padding:16px;
  box-sizing:border-box;
}

.gallery {
  column-count: 2;
  column-gap: 10px;
  max-width: 900px;
  margin: 0 auto;
  visibility: hidden;
}
.gallery a.gallery-item{
  display: block;
  break-inside: avoid;
  margin-bottom: 10px;
  border-radius: 8px;
  overflow: hidden;
}
.gallery img {
  width: 100%;
  height: auto;
  display: block;
  cursor: zoom-in;
  transition: opacity 0.6s ease, transform 0.6s ease;
  opacity: 0;
  transform: translateY(10px);
}
.gallery img.visible {
  opacity: 1;
  transform: translateY(0);
}

@media (max-width: 480px) {
  .gallery { column-count: 1; }
}
</style>
<link rel="stylesheet" href="./lightgallery/lightgallery-bundle.min.css">
<link rel="stylesheet" href="./lightgallery/lg-thumbnail.css">

<script src="./lightgallery/lightgallery.min.js"></script>
<script src="./lightgallery/lg-zoom.min.js"></script>
<script src="./lightgallery/lg-thumbnail.min.js"></script>
<script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {

  function sendHeight() {
    const height = document.documentElement.scrollHeight;
    window.parent.postMessage({ type:"setHeight", height }, "*");
  }

  // ===== Custom CSS for comment panel & favorites overlay =====
  (function(){
    const style = document.createElement("style");
    style.textContent = `
    .lg-custom-btn {
      font-size: 20px;
      cursor: pointer;
      margin-left: 8px;
    }
    #lg-comment-panel {
      position: fixed;
      right: 0;
      top: 0;
      width: 280px;
      max-width: 80%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      color: #fff;
      z-index: 10000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      padding: 12px;
      box-sizing: border-box;
      font-size: 14px;
    }
    #lg-comment-panel.open {
      transform: translateX(0);
    }
    #lg-comment-panel textarea {
      width: 100%;
      height: calc(100% - 40px);
      resize: none;
      background: rgba(0,0,0,0.3);
      color: #fff;
      border: 1px solid #666;
      padding: 6px;
      box-sizing: border-box;
    }
    #lg-comment-panel .lg-comment-header {
      font-weight: bold;
      margin-bottom: 8px;
    }
    #lg-comment-panel .lg-comment-close {
      position: absolute;
      top: 6px;
      right: 8px;
      cursor: pointer;
      font-size: 18px;
    }
    #lg-favorites-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    #lg-favorites-overlay .lg-fav-inner {
      background: #111;
      padding: 12px;
      max-width: 90vw;
      max-height: 80vh;
      overflow: auto;
      border-radius: 8px;
    }
    #lg-favorites-overlay h3 {
      margin: 0 0 8px;
      color: #fff;
      font-size: 16px;
    }
    #lg-favorites-overlay .lg-fav-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
    }
    #lg-favorites-overlay .lg-fav-item {
      cursor: pointer;
    }
    #lg-favorites-overlay .lg-fav-item img {
      width: 100%;
      display: block;
      border-radius: 4px;
    }
    #lg-favorites-overlay .lg-fav-empty {
      color: #ccc;
      font-size: 14px;
    }
    `;
    document.head.appendChild(style);
  })();

  // ===== LocalStorage helpers =====
  const LS_FAV = "mushroomFavorites";
  const LS_COM = "mushroomComments";
  const LS_EXIF = "mushroomExifVisible";

  function loadJson(key, def) {
    try {
      const v = localStorage.getItem(key);
      if (!v) return def;
      return JSON.parse(v);
    } catch(e) {
      return def;
    }
  }
  function saveJson(key, val) {
    try {
      localStorage.setItem(key, JSON.stringify(val));
    } catch(e) {}
  }

  let favorites = loadJson(LS_FAV, {});          // { href: true }
  let commentsMap = loadJson(LS_COM, {});        // { href: "..." }
  let exifVisible = loadJson(LS_EXIF, true);     // bool

  // ===== Comment panel DOM =====
  const commentPanel = document.createElement("div");
  commentPanel.id = "lg-comment-panel";
  commentPanel.innerHTML = `
    <div class="lg-comment-header">„Åì„ÅÆÂÜôÁúü„ÅÆ„É°„É¢</div>
    <div class="lg-comment-close">√ó</div>
    <textarea placeholder="„Åì„ÅÆ„Ç≠„Éé„Ç≥„ÅÆÁâπÂæ¥„ÇÑÂ†¥ÊâÄ„Å™„Å©„ÅÆ„É°„É¢„ÇíÊõ∏„Åë„Åæ„Åô"></textarea>
  `;
  document.body.appendChild(commentPanel);
  const commentTextarea = commentPanel.querySelector("textarea");
  const commentClose = commentPanel.querySelector(".lg-comment-close");
  commentClose.addEventListener("click", () => {
    commentPanel.classList.remove("open");
  });

  // ===== Favorites overlay DOM =====
  const favOverlay = document.createElement("div");
  favOverlay.id = "lg-favorites-overlay";
  favOverlay.innerHTML = `
    <div class="lg-fav-inner">
      <h3>„ÅäÊ∞ó„Å´ÂÖ•„Çä‰∏ÄË¶ß</h3>
      <div class="lg-fav-grid"></div>
      <div class="lg-fav-empty" style="display:none;">„Åæ„Å†„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</div>
    </div>
  `;
  document.body.appendChild(favOverlay);
  const favGrid = favOverlay.querySelector(".lg-fav-grid");
  const favEmpty = favOverlay.querySelector(".lg-fav-empty");
  favOverlay.addEventListener("click", (e) => {
    if (e.target === favOverlay) {
      favOverlay.style.display = "none";
    }
  });

  const gallery = document.querySelector(".gallery");
  let lgInstance = null;
  let galleryItems = [];
  let hrefToIndex = {};

  if (gallery) {
    const fadeObs = new IntersectionObserver(entries=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          e.target.classList.add("visible");
          fadeObs.unobserve(e.target);
        }
      });
    }, {threshold:0.1});
    gallery.querySelectorAll("img").forEach(img=>fadeObs.observe(img));

    imagesLoaded(gallery, () => {
      gallery.style.visibility="visible";
      sendHeight();

      galleryItems = Array.from(gallery.querySelectorAll("a.gallery-item"));
      hrefToIndex = {};
      galleryItems.forEach((a, idx) => {
        const href = a.getAttribute("href");
        if (href) hrefToIndex[href] = idx;
      });

      // ===== LightGallery init =====
      lgInstance = lightGallery(gallery, {
        selector: 'a.gallery-item',
        plugins: [lgZoom, lgThumbnail],
        speed: 400,
        download: false,
        zoom: true,
        thumbnail: true
      });

      // ===== Get current href helper =====
      function getCurrentHref() {
        if (!lgInstance || !galleryItems.length) return null;
        const idx = lgInstance.index || 0;
        const a = galleryItems[idx];
        if (!a) return null;
        return a.getAttribute("href");
      }

      // ===== UI sync helpers =====
      function syncHeartButton(btn) {
        const href = getCurrentHref();
        if (!btn || !href) return;
        if (favorites[href]) {
          btn.textContent = "‚ù§";
          btn.style.color = "#ff4d6a";
        } else {
          btn.textContent = "‚ô°";
          btn.style.color = "";
        }
      }

      function syncCommentPanel() {
        const href = getCurrentHref();
        if (!href) return;
        const txt = commentsMap[href] || "";
        commentTextarea.value = txt;
      }

      function saveCurrentComment() {
        const href = getCurrentHref();
        if (!href) return;
        const val = commentTextarea.value || "";
        if (val.trim()) {
          commentsMap[href] = val;
        } else {
          delete commentsMap[href];
        }
        saveJson(LS_COM, commentsMap);
      }

      function syncExifVisibility() {
        const caption = document.querySelector(".lg-sub-html");
        if (!caption) return;
        caption.style.display = exifVisible ? "" : "none";
      }

      function renderFavoritesOverlay() {
        favGrid.innerHTML = "";
        const favHrefs = Object.keys(favorites).filter(h => favorites[h]);
        if (!favHrefs.length) {
          favEmpty.style.display = "block";
          return;
        }
        favEmpty.style.display = "none";
        favHrefs.forEach(href => {
          const idx = hrefToIndex[href];
          if (idx === undefined) return;
          const a = galleryItems[idx];
          if (!a) return;
          const img = a.querySelector("img");
          const thumbSrc = img ? img.getAttribute("src") : href;
          const item = document.createElement("div");
          item.className = "lg-fav-item";
          item.dataset.href = href;
          item.innerHTML = `<img src="${thumbSrc}" alt="">`;
          favGrid.appendChild(item);
        });
      }

      favGrid.addEventListener("click", (e) => {
        const item = e.target.closest(".lg-fav-item");
        if (!item) return;
        const href = item.dataset.href;
        favOverlay.style.display = "none";
        if (href && hrefToIndex[href] != null && lgInstance) {
          const idx = hrefToIndex[href];
          try {
            lgInstance.slide(idx);
          } catch(e) {}
        }
      });

      // ===== Add custom toolbar buttons after open =====
      lgInstance.on("lgAfterOpen", () => {
        const toolbar = document.querySelector(".lg-toolbar");
        if (!toolbar) return;

        // Avoid duplicate buttons
        if (!toolbar.querySelector(".lg-custom-heart")) {
          const heartBtn = document.createElement("button");
          heartBtn.className = "lg-icon lg-custom-btn lg-custom-heart";
          heartBtn.title = "„ÅäÊ∞ó„Å´ÂÖ•„Çä";
          toolbar.appendChild(heartBtn);
          heartBtn.addEventListener("click", () => {
            const href = getCurrentHref();
            if (!href) return;
            if (favorites[href]) {
              delete favorites[href];
            } else {
              favorites[href] = true;
            }
            saveJson(LS_FAV, favorites);
            syncHeartButton(heartBtn);
          });
        }

        if (!toolbar.querySelector(".lg-custom-comment")) {
          const commentBtn = document.createElement("button");
          commentBtn.className = "lg-icon lg-custom-btn lg-custom-comment";
          commentBtn.textContent = "üìù";
          commentBtn.title = "„É°„É¢„ÇíÊõ∏„Åè";
          toolbar.appendChild(commentBtn);
          commentBtn.addEventListener("click", () => {
            syncCommentPanel();
            commentPanel.classList.add("open");
            commentTextarea.focus();
          });
          commentTextarea.addEventListener("input", () => {
            saveCurrentComment();
          });
        }

        if (!toolbar.querySelector(".lg-custom-exif")) {
          const exifBtn = document.createElement("button");
          exifBtn.className = "lg-icon lg-custom-btn lg-custom-exif";
          exifBtn.textContent = "üì∑";
          exifBtn.title = "EXIFË°®Á§∫ÂàáÊõø";
          toolbar.appendChild(exifBtn);
          exifBtn.addEventListener("click", () => {
            exifVisible = !exifVisible;
            saveJson(LS_EXIF, exifVisible);
            syncExifVisibility();
          });
        }

        if (!toolbar.querySelector(".lg-custom-share")) {
          const shareBtn = document.createElement("button");
          shareBtn.className = "lg-icon lg-custom-btn lg-custom-share";
          shareBtn.textContent = "üîó";
          shareBtn.title = "ÂÖ±Êúâ";
          toolbar.appendChild(shareBtn);
          shareBtn.addEventListener("click", () => {
            const href = getCurrentHref() || window.location.href;
            const shareUrl = href;
            if (navigator.share) {
              navigator.share({
                title: document.title || "„Éï„Ç©„Éà„ÇÆ„É£„É©„É™„Éº",
                url: shareUrl
              }).catch(()=>{});
            } else {
              // Á∞°Êòì„É°„Éã„É•„ÉºÔºöX / LINE / „Ç≥„Éî„Éº
              const msg = "ÂÖ±ÊúâÊñπÊ≥ï„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑÔºö\n1: X„Å´ÊäïÁ®ø\n2: LINE„ÅßÂÖ±Êúâ\n3: URL„Çí„Ç≥„Éî„Éº";
              const choice = window.prompt(msg, "3");
              if (choice === "1") {
                const url = "https://twitter.com/intent/tweet?url=" + encodeURIComponent(shareUrl);
                window.open(url, "_blank");
              } else if (choice === "2") {
                const url = "https://line.me/R/msg/text/?" + encodeURIComponent(shareUrl);
                window.open(url, "_blank");
              } else {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                  navigator.clipboard.writeText(shareUrl).then(()=>{
                    alert("URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü");
                  }).catch(()=>{
                    alert("URL: " + shareUrl);
                  });
                } else {
                  alert("URL: " + shareUrl);
                }
              }
            }
          });
        }

        if (!toolbar.querySelector(".lg-custom-slideshow")) {
          let playing = false;
          let timer = null;
          const slideBtn = document.createElement("button");
          slideBtn.className = "lg-icon lg-custom-btn lg-custom-slideshow";
          slideBtn.textContent = "‚ñ∂";
          slideBtn.title = "„Çπ„É©„Ç§„Éâ„Ç∑„Éß„Éº";
          toolbar.appendChild(slideBtn);

          slideBtn.addEventListener("click", () => {
            playing = !playing;
            if (playing) {
              slideBtn.textContent = "‚è∏";
              slideBtn.title = "ÂÅúÊ≠¢";
              timer = setInterval(() => {
                if (lgInstance) {
                  lgInstance.slideNext();
                }
              }, 3000);
            } else {
              slideBtn.textContent = "‚ñ∂";
              slideBtn.title = "„Çπ„É©„Ç§„Éâ„Ç∑„Éß„Éº";
              if (timer) {
                clearInterval(timer);
                timer = null;
              }
            }
          });

          // gallery„ÇíÈñâ„Åò„Åü„Çâ„Çπ„É©„Ç§„Éâ„Ç∑„Éß„Éº„ÇÇÂÅúÊ≠¢
          lgInstance.on("lgBeforeClose", () => {
            playing = false;
            if (timer) {
              clearInterval(timer);
              timer = null;
            }
            slideBtn.textContent = "‚ñ∂";
            slideBtn.title = "„Çπ„É©„Ç§„Éâ„Ç∑„Éß„Éº";
          });
        }

        if (!toolbar.querySelector(".lg-custom-favlist")) {
          const favListBtn = document.createElement("button");
          favListBtn.className = "lg-icon lg-custom-btn lg-custom-favlist";
          favListBtn.textContent = "‚≠ê";
          favListBtn.title = "„ÅäÊ∞ó„Å´ÂÖ•„Çä‰∏ÄË¶ß";
          toolbar.appendChild(favListBtn);
          favListBtn.addEventListener("click", () => {
            renderFavoritesOverlay();
            favOverlay.style.display = "flex";
          });
        }

        // ÂàùÂõû„Ç™„Éº„Éó„É≥ÊôÇ„Å´Áä∂ÊÖã„ÇíÂêåÊúü
        const heartBtn = toolbar.querySelector(".lg-custom-heart");
        syncHeartButton(heartBtn);
        syncCommentPanel();
        syncExifVisibility();
      });

      // „Çπ„É©„Ç§„Éâ„ÅåÂ§â„Çè„Çã„Åü„Å≥„Å´Áä∂ÊÖãÊõ¥Êñ∞
      lgInstance.on("lgAfterSlide", () => {
        const toolbar = document.querySelector(".lg-toolbar");
        if (!toolbar) return;
        const heartBtn = toolbar.querySelector(".lg-custom-heart");
        syncHeartButton(heartBtn);
        syncCommentPanel();
        syncExifVisibility();
      });

      // === fullscreen & Ë¶™ÈÄöÁü•ÔºàÊó¢Â≠òÊ©üËÉΩ„ÇíÁ∂≠ÊåÅÔºâ ===
      gallery.querySelectorAll("a.gallery-item").forEach((a) => {
        a.addEventListener("click", () => {
          const el = document.documentElement;
          if (el.requestFullscreen) el.requestFullscreen();
          else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
          else if (el.msRequestFullscreen) el.msRequestFullscreen();
        });
      });

      gallery.addEventListener("lgBeforeClose", () => {
        console.log("üì§ Â≠êÔºöLG before close Áô∫ÁÅ´");
        if (document.fullscreenElement) {
          document.exitFullscreen().catch(()=>{});
        }
        window.parent.postMessage({ type: "lgClosed" }, "*");
      });

      document.addEventListener("fullscreenchange", () => {
        if (!document.fullscreenElement) {
          console.log("üì§ Â≠êÔºöfullscreenchangeÁô∫ÁÅ´ ‚Üí Ë¶™„Å´ lgClosed „ÇíÈÄÅ‰ø°");
          try {
            if (lgInstance) lgInstance.closeGallery();
            window.parent.postMessage({ type: "lgClosed" }, "*");
          } catch(e) {}
        }
      });

    }); // imagesLoaded
  } // if(gallery)

  // === „ÇØ„É™„ÉÉ„ÇØÂà§ÂÆöÔºàscrollToTitle Áî®ÔºöÊó¢Â≠òÁ∂≠ÊåÅÔºâ ===
  document.addEventListener("click", (e) => {
    const a = e.target.closest("a");
    if (!a) return;

    const txt = a.textContent || "";
    const href = a.getAttribute("href") || "";

    console.log("[iframe] click anchor:", { text: txt, href });

    // 1) „Ç≠„Éé„Ç≥Âêç„Éö„Éº„Ç∏ (xxx.html)
    if (href.endsWith(".html")) {
      console.log("[iframe] send scrollToTitle (html link)");
      window.parent.postMessage({ type: "scrollToTitle" }, "*");
      return;
    }

    // 2) „ÅÇË°å„Äú„ÇèË°å
    if (/^(„ÅÇË°å|„ÅãË°å|„ÅïË°å|„ÅüË°å|„Å™Ë°å|„ÅØË°å|„ÅæË°å|„ÇÑË°å|„ÇâË°å|„ÇèË°å)$/.test(txt)) {
      console.log("[iframe] send scrollToTitle (aiuo link)");
      window.parent.postMessage({ type: "scrollToTitle" }, "*");
      return;
    }

    // 3) ‚Üê Êàª„Çã
    if (/Êàª„Çã/.test(txt)) {
      console.log("[iframe] send scrollToTitle (back)");
      window.parent.postMessage({ type: "scrollToTitle" }, "*");
      return;
    }
  });

  sendHeight();
  window.addEventListener("load", ()=>{ sendHeight(); setTimeout(sendHeight,800); setTimeout(sendHeight,2000); });
  window.addEventListener("message", e=>{ if(e.data?.type==="requestHeight") sendHeight(); });
  window.addEventListener("resize", sendHeight);
  new MutationObserver(sendHeight).observe(document.body,{childList:true,subtree:true});

});
</script>
